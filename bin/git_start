#!/usr/bin/env bash

set -o nounset
set -o pipefail

current="$(git current)"
default="$(git default)"

if [ "${current}" != "${default}" ]; then
    git checkout "${default}"
fi

case "${1}" in
    jira)
        issue="$(echo ${2} | awk '{print toupper($0)}')"
        brief="$(echo ${@:3} | sed 's/ /-/g')"
        if [ -z "${brief}" ]; then
            branches="$(git branch --list | grep "${issue}-" | awk '{print $1}')"
            if [ $(echo "${branches}" | wc -l) -gt 1 ]; then
                echo please refine the branch:
                for branch in $branches; do
                    echo - $branch
                done
            else
                branch="${branches}"
                git checkout "${branch}"
            fi
        else
            branches="$(git branch --list | grep "${issue}-${brief}" | awk '{print $1}')"
            if [ $(echo "${branches}" | wc -l) -gt 1 ]; then
                echo please refine the branch:
                for branch in $branches; do
                    echo - $branch
                done
            elif [ -n "${branches}" ]; then
                branch="${branches}"
                git checkout "${branch}"
            else
                branch="${issue}-${brief}"
                git pull --rebase 2>/dev/null || true
                git checkout -b "${branch}"
            fi
        fi
    ;;
    *)
        (>&2 echo nothing to do)
        exit 1
    ;;
esac

echo done
exit 0
